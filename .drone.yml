---
kind: pipeline
name: generate-schema

steps:
- name: setupphp80
  image: docker
  volumes:
  - name: docker
    path: /var/run/docker.sock
  commands:
    - docker build --rm -t snowcookie/generate-schema-php80 ./docker/php80

- name: testphp80
  image: snowcookie/generate-schema-php80:latest
  pull: if-not-exists
  volumes:
  - name: vendorphp80
    path: /drone/src/vendor
  commands:
    - composer install
    - vendor/bin/phpunit --testsuite "Package Test Suite" -v --debug
  depends_on:
    - setupphp80

- name: setupphp81
  image: docker
  volumes:
  - name: docker
    path: /var/run/docker.sock
  commands:
    - docker build --rm -t snowcookie/generate-schema-php81 ./docker/php81

- name: testphp81
  image: snowcookie/generate-schema-php81:latest
  pull: if-not-exists
  volumes:
  - name: vendorphp81
    path: /drone/src/vendor
  commands:
    - composer install
    - vendor/bin/phpunit --testsuite "Package Test Suite" -v --debug
  depends_on:
    - setupphp81
    - testphp80

services:
- name: snowcookie-generate-schema-mysql
  image: mysql:8
  pull: always
  environment:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: homestead
    MYSQL_USER: homestead
    MYSQL_PASSWORD: secret
  command: [ "--default-authentication-plugin=mysql_native_password" ]

- name: snowcookie-generate-schema-postgres
  image: postgres:11
  pull: always
  environment:
    POSTGRES_DB: homestead
    POSTGRES_PASSWORD: secret
    POSTGRES_USER: homestead

volumes:
- name: docker
  host:
    path: /var/run/docker.sock

- name: vendorphp73
  host:
    path: /home/snow/drone/${DRONE_REPO_NAME}/php73/vendor

- name: vendorphp74
  host:
    path: /home/snow/drone/${DRONE_REPO_NAME}/php74/vendor
